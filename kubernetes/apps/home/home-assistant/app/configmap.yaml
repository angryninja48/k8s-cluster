---
apiVersion: v1
kind: ConfigMap
metadata:
  name: git-sync-scripts
  namespace: home
data:
  sync-to-config.sh: |
    #!/bin/sh
    set -eu

    # This script is called by git-sync's --exechook-command after each successful sync
    # It copies files from the git-sync worktree to /config/ where Home Assistant expects them

    SYNC_ROOT="${GIT_SYNC_ROOT:-/git-sync-root}"
    SYNC_LINK="${GIT_SYNC_LINK:-/git-sync-root/home-assistant-config}"
    TARGET_DIR="/config"

    echo "$(date): Starting sync from git-sync worktree to ${TARGET_DIR}"

    # Verify source exists
    if [ ! -d "${SYNC_LINK}" ]; then
      echo "ERROR: Source directory ${SYNC_LINK} does not exist"
      exit 1
    fi

    # Use rsync to atomically update /config with git repository contents
    # --archive: preserve permissions, timestamps, etc.
    # --delete: remove files in dest that don't exist in source
    # --delay-updates: apply all changes atomically at the end
    # --exclude: don't overwrite HA runtime files
    rsync -av --delete --delay-updates \
      --exclude='.storage/' \
      --exclude='home-assistant_v2.db*' \
      --exclude='home-assistant.log*' \
      --exclude='*.log' \
      --exclude='*.db-shm' \
      --exclude='*.db-wal' \
      --exclude='.git-sync-root/' \
      --exclude='.HA_VERSION' \
      --exclude='deps/' \
      --exclude='tts/' \
      --exclude='*.conf' \
      "${SYNC_LINK}/" "${TARGET_DIR}/"

    RSYNC_EXIT=$?

    if [ $RSYNC_EXIT -eq 0 ]; then
      echo "$(date): Sync completed successfully"
    else
      echo "$(date): ERROR: rsync failed with exit code $RSYNC_EXIT"
      exit $RSYNC_EXIT
    fi
