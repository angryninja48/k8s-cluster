---
apiVersion: v1
kind: ConfigMap
metadata:
  name: git-sync-scripts
  namespace: home
data:
  sync-to-config.sh: |
    #!/bin/sh
    set -eu

    # This script is called by git-sync's --exechook-command after each successful sync
    # It copies files from the git-sync worktree to /config/ where Home Assistant expects them

    SYNC_ROOT="${GITSYNC_ROOT:-/git-sync-root}"
    SYNC_LINK="${GITSYNC_LINK:-/git-sync-root/home-assistant-config}"
    TARGET_DIR="/config"

    echo "$(date): Starting sync from git-sync worktree to ${TARGET_DIR}"

    # Verify source exists
    if [ ! -d "${SYNC_LINK}" ]; then
      echo "ERROR: Source directory ${SYNC_LINK} does not exist"
      exit 1
    fi

    # Create temp marker to track what we're syncing
    MARKER_FILE="${TARGET_DIR}/.git-sync-marker"

    # Copy all files from source to destination using cp (available in Debian base)
    # Using find + cp to handle exclusions without needing rsync
    cd "${SYNC_LINK}"

    find . -type f \
      ! -path './.storage/*' \
      ! -path './home-assistant_v2.db*' \
      ! -path './*.log' \
      ! -path './*.db-shm' \
      ! -path './*.db-wal' \
      ! -path './.HA_VERSION' \
      ! -path './deps/*' \
      ! -path './tts/*' \
      ! -path './*.conf' \
      -print0 | while IFS= read -r -d '' file; do
        # Create parent directory if needed
        mkdir -p "${TARGET_DIR}/$(dirname "$file")"
        # Copy file
        cp -f "$file" "${TARGET_DIR}/$file"
    done

    # Write marker with current sync time
    date > "${MARKER_FILE}"

    echo "$(date): Sync completed successfully"
